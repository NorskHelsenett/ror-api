services:
  rabbitmq:
    image: ${DOCKER_MIRROR}rabbitmq:4-management-alpine
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=S3cret!
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/rabbitmq:/var/log/rabbitmq
    ports:
      - '6672:5672'
      - '16672:15672'
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 20s
      timeout: 15s
      retries: 10

  mongodb:
    image: ${DOCKER_MIRROR}mongo:8-noble
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/mongodb:/data/db:rw
      - ${ROR_ASSETS_PATH:-./hacks/assets}/mongodb:/docker-entrypoint-initdb.d
    environment:
      - MONGO_INITDB_DATABASE=nhn-ror
      - MONGO_INITDB_ROOT_USERNAME=someone
      - MONGO_INITDB_ROOT_PASSWORD=S3cret!
      - MONGODB_DISABLE_SYSTEM_LOG=false
      - MONGODB_SYSTEM_LOG_VERBOSITY=5
    ports:
      - '28017:27017'
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 15s

  mongo-express:
    image: ${DOCKER_MIRROR}mongo-express:latest
    restart: always
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=someone
      - ME_CONFIG_MONGODB_ADMINPASSWORD=S3cret!
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_MONGODB_URL="mongodb:/someone:S3cret!@mongodb:27017/"
      - ME_CONFIG_BASICAUTH_USERNAME=test
      - ME_CONFIG_BASICAUTH_PASSWORD=S3cr3t
    depends_on:
      mongodb:
        condition: service_healthy
    links:
      - mongodb
    ports:
      - '9081:8081'
    profiles:
      - ui

  dex:
    image: ${DOCKER_MIRROR}dexidp/dex:v2.42.1-alpine
    restart: always
    volumes:
      - ${ROR_ASSETS_PATH:-./hacks/assets}/dex/configs:/configs
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/dex/dbs:/dbs
    command: dex serve /configs/dex-config-default.yaml
    depends_on:
      openldap:
        condition: service_started
      init-dex-db:
        condition: service_completed_successfully
    links:
      - openldap
    ports:
      - '6554:6554'
      - '6556:6556'
      - '6557:6557'
      - '6558:6558'

  init-dex-db:
    image: ${DOCKER_MIRROR}busybox
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/dex/dbs:/dbs
    entrypoint:
      [
        'sh',
        '-c',
        "touch /dbs/dex.db && chmod 766 /dbs/dex.db && chmod 777 /dbs && echo 'dex.db file created.'",
      ]
    restart: 'no'

  vault:
    image: hashicorp/vault:1.18.3
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_ADDR=http:/vault:8200
      - VAULT_FORMAT=json
      - APPROLE_ROLE_ID=test
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/vault/secrets:/tmp/secrets
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/vault/data:/vault/data:rw
      - ${ROR_ASSETS_PATH:-./hacks/assets}/vault/entrypoint.sh:/vault/entrypoint.sh:rw
      - ${ROR_ASSETS_PATH:-./hacks/assets}/vault/policies:/policies
      - ${ROR_ASSETS_PATH:-./hacks/assets}/vault/ldapconfig.json:/vault/config/ldapconfig.json
      - .env:/vault/config/envfile:rw
    entrypoint:
      - '/vault/entrypoint.sh'
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      valkey:
        condition: service_healthy
    links:
      - mongodb
      - rabbitmq
    ports:
      - '9200:8200'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http:/vault:8200/v1/sys/health']
      interval: 5s
      retries: 5
      start_period: 8s
      timeout: 2s

  openldap:
    image: ${DOCKER_MIRROR}osixia/openldap:1.5.0
    command: ['--copy-service']
    environment:
      LDAP_TLS_VERIFY_CLIENT: try
      LDAP_ORGANISATION: 'ROR by NHN'
      LDAP_DOMAIN: ror.dev
    volumes:
      - ${ROR_ASSETS_PATH:-./hacks/assets}/openldap/config-ldap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/custom-config.ldif
    ports:
      - '1389:389'

  jaeger:
    image: ${DOCKER_MIRROR}jaegertracing/all-in-one:latest
    ports:
      - '17686:16686'
      - '15250:14250'
    profiles:
      - tracing

  opentelemetry-collector:
    image: ${DOCKER_MIRROR}otel/opentelemetry-collector:latest
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/opentelemetry-collector/configs:/configs
    command: ['--config=/configs/opentelemetry-collector-config.yaml']
    depends_on:
      - jaeger
    ports:
      - '5317:4317'
    profiles:
      - tracing
  valkey:
    image: ${DOCKER_MIRROR}valkey/valkey
    environment:
      VALKEY_EXTRA_FLAGS: '--requirepass S3cret!'
    volumes:
      - ${DOCKER_VOLUME_PATH:-../ror/hacks/data}/valkey/data:/data
    ports:
      - '7379:6379'
      - '9001:8001'
    healthcheck:
      test: ['CMD', 'valkey-cli', 'ping']

  valkey-commander:
    image: rediscommander/redis-commander:latest
    container_name: ${COMPOSE_PROJECT_NAME}-valkey-ui
    restart: unless-stopped
    platform: linux/amd64
    ports:
      - '9082:8081'
    environment:
      - REDIS_HOSTS=ror-api:valkey:6379:0:S3cret!
    depends_on:
      - valkey
    profiles:
      - ui
  mocc:
    image: ghcr.io/jonasbg/mocc:latest
    container_name: ${COMPOSE_PROJECT_NAME}-mocc
    restart: unless-stopped
    ports:
      - '6006:6006'
    environment:
      - PORT=6006
    volumes:
      - ${ROR_ASSETS_PATH:-./hacks/assets}/mocc/users.yaml:/config/users.yaml:ro
    profiles:
      - mocc
volumes:
  data: {}

